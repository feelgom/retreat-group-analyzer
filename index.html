<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetWeEn 수련회 조별 분포</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        .charts-container {
            display: grid;
            gap: 30px;
        }
        .chart-item {
            background: #fafafa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chart-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        canvas {
            max-height: 400px;
        }
        .stats {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #555;
        }
        .pdf-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px;
            transition: transform 0.2s;
        }
        .pdf-btn:hover {
            transform: translateY(-2px);
        }
        .refresh-btn {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px;
            transition: transform 0.2s;
        }
        .refresh-btn:hover {
            transform: translateY(-2px);
        }
        .loading {
            text-align: center;
            color: #667eea;
            font-size: 1.2em;
            margin: 20px 0;
        }
        .error-message {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            border-left: 4px solid #d63031;
        }
        .success-message {
            background: #e8f5e8;
            color: #00b894;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            border-left: 4px solid #00b894;
        }
        .overall-stats {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        .overall-stats h2 {
            margin: 0 0 20px 0;
            color: #333;
            text-align: center;
            font-size: 1.8em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 15px;
        }
        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        .stat-detail {
            font-size: 0.85em;
            color: #888;
        }
        .gender-chart {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        .gender-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #f8f9ff;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .gender-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .male-color { background: #3498db; }
        .female-color { background: #e74c3c; }
        .last-updated {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            font-size: 0.9em;
            color: #667eea;
        }
        .last-updated strong {
            color: #333;
        }
        .sample-mode {
            position: relative;
        }
        .sample-mode .charts-container {
            filter: blur(2px);
            opacity: 0.7;
        }
        .sample-mode .overall-stats {
            filter: blur(1px);
            opacity: 0.8;
        }
        .sample-warning {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            color: #d63031;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid #e17055;
            box-shadow: 0 4px 15px rgba(209, 48, 49, 0.2);
            font-weight: bold;
            font-size: 1.1em;
            position: relative;
            z-index: 10;
        }
        .sample-warning h3 {
            margin: 0 0 10px 0;
            font-size: 1.3em;
            color: #2d3436;
        }
        .refresh-notice {
            background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
            color: #2d3436;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid #e17055;
            box-shadow: 0 4px 15px rgba(225, 112, 85, 0.2);
            font-weight: bold;
            font-size: 1.1em;
        }
        .refresh-notice h3 {
            margin: 0 0 10px 0;
            font-size: 1.3em;
            color: #2d3436;
        }
        .refresh-guide-btn {
            background: linear-gradient(45deg, #00b894, #00a085);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px;
            transition: transform 0.2s;
        }
        .refresh-guide-btn:hover {
            transform: translateY(-2px);
        }
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* 아이폰 15 및 모바일 최적화 스타일 */
        @media (max-width: 414px) {
            body {
                padding: 10px;
                font-size: 14px;
            }
            
            .container {
                padding: 20px 15px;
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
                line-height: 1.2;
                margin-bottom: 10px;
            }
            
            .header p {
                font-size: 0.9em;
                margin-bottom: 0;
            }
            
            .controls {
                margin-bottom: 15px;
                display: flex;
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            
            .pdf-btn, .refresh-btn, .refresh-guide-btn {
                width: 100%;
                max-width: 280px;
                padding: 15px 20px;
                font-size: 0.95em;
                border-radius: 12px;
                margin: 5px 0;
            }
            
            .overall-stats {
                padding: 15px;
                margin: 15px 0;
            }
            
            .overall-stats h2 {
                font-size: 1.4em;
                margin-bottom: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-item {
                padding: 15px 10px;
                border-radius: 8px;
            }
            
            .stat-number {
                font-size: 1.8em;
                margin-bottom: 3px;
            }
            
            .stat-label {
                font-size: 0.8em;
                margin-bottom: 5px;
            }
            
            .stat-detail {
                font-size: 0.75em;
            }
            
            .charts-container {
                gap: 20px;
            }
            
            .chart-item {
                padding: 15px;
                border-radius: 8px;
            }
            
            .chart-title {
                font-size: 1.1em;
                margin-bottom: 10px;
            }
            
            canvas {
                max-height: 300px;
            }
            
            .stats {
                padding: 12px;
                font-size: 0.85em;
                line-height: 1.4;
            }
            
            .gender-chart {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            
            .gender-item {
                padding: 6px 12px;
                font-size: 0.8em;
            }
            
            .last-updated {
                padding: 8px;
                font-size: 0.8em;
                margin-top: 10px;
            }
            
            .error-message, .success-message, .loading {
                padding: 12px;
                font-size: 0.9em;
                border-radius: 6px;
                margin: 15px 0;
            }
            
            .sample-warning, .refresh-notice {
                padding: 15px;
                margin: 15px 0;
                border-radius: 10px;
                font-size: 0.95em;
            }
            
            .sample-warning h3, .refresh-notice h3 {
                font-size: 1.1em;
                margin-bottom: 8px;
            }
        }
        
        /* 아이폰 15 Pro/Max 및 더 큰 모바일 화면 */
        @media (min-width: 415px) and (max-width: 767px) {
            body {
                padding: 15px;
            }
            
            .container {
                padding: 25px 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .controls {
                display: flex;
                flex-direction: row;
                justify-content: center;
                gap: 15px;
                flex-wrap: wrap;
            }
            
            .pdf-btn, .refresh-btn, .refresh-guide-btn {
                min-width: 140px;
                padding: 12px 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            canvas {
                max-height: 350px;
            }
        }
        
        /* 터치 친화적 스타일 */
        @media (hover: none) and (pointer: coarse) {
            .pdf-btn, .refresh-btn, .refresh-guide-btn {
                min-height: 48px;
                padding: 15px 25px;
                font-size: 1em;
                touch-action: manipulation;
            }
            
            .pdf-btn:active, .refresh-btn:active, .refresh-guide-btn:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }
        }
        
        /* 가로 모드 최적화 */
        @media (max-width: 926px) and (orientation: landscape) {
            .overall-stats {
                margin: 10px 0;
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
            }
            
            .stat-item {
                padding: 10px;
            }
            
            .stat-number {
                font-size: 1.5em;
            }
            
            .chart-item {
                padding: 15px;
            }
            
            canvas {
                max-height: 250px;
            }
        }
        
        /* 매우 작은 화면 (320px 이하) */
        @media (max-width: 320px) {
            body {
                padding: 5px;
                font-size: 13px;
            }
            
            .container {
                padding: 15px 10px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .chart-title {
                font-size: 1em;
            }
            
            .pdf-btn, .refresh-btn, .refresh-guide-btn {
                font-size: 0.9em;
                padding: 12px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏕️ 청년교구 BetWeEn 수련회 조별 분포 👬</h1>
            <p>각 조의 연령대별 인원 분포를 확인해보세요</p>
        </div>
        
        <div class="controls">
            <button class="refresh-btn" onclick="loadGoogleSheetData()">
                🔄 데이터 새로고침
            </button>
            <button class="pdf-btn" onclick="downloadPDF()">
                📄 PDF로 저장
            </button>
        </div>

        <div id="messageContainer"></div>
        
        <div id="overallStats" class="overall-stats" style="display: none;">
            <h2>📊 전체 통계</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number">0</div>
                    <div class="stat-label">전체 인원</div>
                    <div class="stat-detail">0개 조</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">0</div>
                    <div class="stat-label">남성</div>
                    <div class="stat-detail">0%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">0</div>
                    <div class="stat-label">여성</div>
                    <div class="stat-detail">0%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">0</div>
                    <div class="stat-label">평균 나이</div>
                    <div class="stat-detail">세</div>
                </div>
            </div>
            <div class="last-updated">
                <strong>마지막 업데이트:</strong>
            </div>
        </div>
        
        <div id="chartsContainer" class="charts-container">
            <!-- 차트들이 여기에 동적으로 추가됩니다 -->
        </div>
    </div>

    <script>
        let chartInstances = [];
        let isSampleMode = false; // 샘플 데이터 모드 플래그
        
        // 구글 시트 CSV URL
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1gmzAJM8JgGG8fRewoPShRh4j0nWJ7LeO/export?format=csv&gid=1530529588';

        // 마지막 업데이트 시간 표시 함수
        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const lastUpdatedElement = document.querySelector('.last-updated');
            if (lastUpdatedElement) {
                if (isSampleMode) {
                    lastUpdatedElement.innerHTML = `<strong>샘플 데이터 로드 시간:</strong> ${timeString}`;
                } else {
                    lastUpdatedElement.innerHTML = `<strong>마지막 업데이트:</strong> ${timeString}`;
                }
            }
        }

        // 메시지 표시 함수
        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('messageContainer');
            const messageClass = type === 'error' ? 'error-message' : 
                                type === 'success' ? 'success-message' : 'loading';
            
            messageContainer.innerHTML = `<div class="${messageClass}">${message}</div>`;
            
            if (type !== 'loading') {
                setTimeout(() => {
                    if (!isSampleMode) { // 샘플 모드가 아닐 때만 메시지 제거
                        messageContainer.innerHTML = '';
                    }
                }, 5000);
            }
        }

        // CORS 오류 시 새로고침 안내 표시
        function showRefreshNotice() {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = `
                <div class="refresh-notice">
                    <h3>🚫 데이터 접근 제한</h3>
                    <p>보안 정책(CORS)으로 인해 구글 시트 데이터에 접근할 수 없습니다.</p>
                    <p><strong>페이지를 새로고침</strong>하거나 잠시 후 다시 시도해주세요.</p>
                    <button class="refresh-guide-btn" onclick="location.reload()">
                        🔄 페이지 새로고침
                    </button>
                </div>
            `;
        }

        // 샘플 데이터 경고 표시
        function showSampleWarning() {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = `
                <div class="sample-warning">
                    <h3>⚠️ 샘플 데이터 모드</h3>
                    <p>현재 표시되는 데이터는 <strong>샘플 데이터</strong>입니다.</p>
                    <p>실제 수련회 데이터를 보려면 위의 <strong>"데이터 새로고침"</strong> 버튼을 클릭하거나 페이지를 새로고침해주세요.</p>
                </div>
            `;
        }

        // 샘플 모드 UI 적용/제거
        function toggleSampleMode(enable) {
            const container = document.querySelector('.container');
            if (enable) {
                container.classList.add('sample-mode');
                isSampleMode = true;
                showSampleWarning();
            } else {
                container.classList.remove('sample-mode');
                isSampleMode = false;
                document.getElementById('messageContainer').innerHTML = '';
            }
        }

        // 구글 시트에서 데이터 가져오기 (JSONP 방식)
        async function loadGoogleSheetData() {
            try {
                // 샘플 모드 해제
                toggleSampleMode(false);
                
                showMessage('🔄 구글 시트에서 데이터를 가져오는 중...', 'loading');
                
                // 캐시 무효화를 위한 타임스탬프 추가
                const timestamp = new Date().getTime();
                const cacheBuster = `&_=${timestamp}&random=${Math.random()}`;
                const googleSheetUrlWithCacheBuster = GOOGLE_SHEET_URL + cacheBuster;
                
                // CORS 프록시를 사용하여 데이터 가져오기
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const targetUrl = encodeURIComponent(googleSheetUrlWithCacheBuster);
                
                console.log('요청 URL:', proxyUrl + targetUrl);
                
                const response = await fetch(proxyUrl + targetUrl, {
                    method: 'GET',
                    cache: 'no-cache'  // 브라우저 캐시 무시
                });
                
                // 응답 헤더 정보 로깅
                console.log('Response Headers:');
                for (let [key, value] of response.headers.entries()) {
                    console.log(`${key}: ${value}`);
                }
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('CSV 데이터 길이:', csvText.length);
                console.log('CSV 첫 200자:', csvText.substring(0, 200));
                
                // CSV 데이터가 올바른지 확인
                if (!csvText || csvText.trim() === '') {
                    throw new Error('빈 데이터를 받았습니다.');
                }
                
                // 응답 헤더에서 마지막 수정 시간 추출
                const lastModified = response.headers.get('last-modified');
                const etag = response.headers.get('etag');
                const cacheControl = response.headers.get('cache-control');
                
                console.log('Last-Modified:', lastModified);
                console.log('ETag:', etag);
                console.log('Cache-Control:', cacheControl);
                
                processCSVData(csvText);
                
                // 성공 메시지에 헤더 정보 포함
                let successMessage = '✅ 구글 시트 데이터를 성공적으로 불러왔습니다!';
                if (lastModified) {
                    const modifiedDate = new Date(lastModified);
                    successMessage += `<br>📅 시트 수정 시간: ${modifiedDate.toLocaleString('ko-KR')}`;
                }
                
                showMessage(successMessage, 'success');
                updateLastUpdatedTime();
                
            } catch (error) {
                console.error('구글 시트 데이터 로딩 오류:', error);
                
                // 다른 방법으로 시도
                tryAlternativeMethod();
            }
        }

        // 대안 방법 시도
        async function tryAlternativeMethod() {
            try {
                showMessage('🔄 다른 방법으로 데이터를 가져오는 중...', 'loading');
                
                // 캐시 무효화를 위한 타임스탬프 추가
                const timestamp = new Date().getTime();
                const cacheBuster = `&_=${timestamp}&random=${Math.random()}`;
                const googleSheetUrlWithCacheBuster = GOOGLE_SHEET_URL + cacheBuster;
                
                // 다른 CORS 프록시 시도
                const corsProxy = 'https://cors-anywhere.herokuapp.com/';
                const response = await fetch(corsProxy + googleSheetUrlWithCacheBuster, {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                console.log('Alternative method - Response Headers:');
                for (let [key, value] of response.headers.entries()) {
                    console.log(`${key}: ${value}`);
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('Alternative method - CSV 데이터 길이:', csvText.length);
                
                processCSVData(csvText);
                
                // 응답 헤더에서 마지막 수정 시간 추출
                const lastModified = response.headers.get('last-modified');
                let successMessage = '✅ 구글 시트 데이터를 성공적으로 불러왔습니다!';
                if (lastModified) {
                    const modifiedDate = new Date(lastModified);
                    successMessage += `<br>📅 시트 수정 시간: ${modifiedDate.toLocaleString('ko-KR')}`;
                }
                
                showMessage(successMessage, 'success');
                updateLastUpdatedTime();
                
            } catch (error) {
                console.error('대안 방법도 실패:', error);
                
                // CORS 오류 안내 및 새로고침 권장
                showRefreshNotice();
                
                // 3초 후 샘플 데이터로 전환
                setTimeout(() => {
                    toggleSampleMode(true);
                    loadSampleData();
                }, 3000);
            }
        }

        // CSV 데이터 처리 함수
        function processCSVData(csvText) {
            try {
                const lines = csvText.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                // 컬럼 인덱스 찾기
                const groupIndex = headers.findIndex(h => h.includes('조') || h.includes('편성'));
                const nameIndex = headers.findIndex(h => h.includes('이름'));
                const birthIndex = headers.findIndex(h => h.includes('생년월일') || h.includes('생일'));
                const genderIndex = headers.findIndex(h => h.includes('성별'));
                
                if (groupIndex === -1 || nameIndex === -1 || birthIndex === -1) {
                    throw new Error('필요한 컬럼(조편성, 이름, 생년월일)을 찾을 수 없습니다.');
                }

                // 데이터 파싱
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= Math.max(groupIndex, nameIndex, birthIndex, genderIndex) + 1) {
                        const groupValue = values[groupIndex];
                        const birthValue = values[birthIndex];
                        
                        // 빈 데이터나 잘못된 데이터 필터링
                        if (groupValue && birthValue && values[nameIndex]) {
                            data.push({
                                group: parseInt(groupValue) || groupValue,
                                name: values[nameIndex],
                                birthDate: birthValue,
                                gender: genderIndex >= 0 ? values[genderIndex] : '미상'
                            });
                        }
                    }
                }

                createChartsFromData(data);

            } catch (error) {
                console.error('CSV 데이터 처리 오류:', error);
                showMessage('❌ 데이터 처리 중 오류가 발생했습니다: ' + error.message, 'error');
            }
        }

        // CSV 라인 파싱 (쉼표와 따옴표 처리)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/"/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim().replace(/"/g, ''));
            return result;
        }

        // 데이터로부터 차트 생성
        function createChartsFromData(data) {
            // 기존 차트 제거
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];
            document.getElementById('chartsContainer').innerHTML = '';

            // 전체 통계 업데이트
            updateOverallStats(data);

            // 조별로 데이터 그룹화
            const groups = {};
            data.forEach(person => {
                if (!groups[person.group]) {
                    groups[person.group] = [];
                }
                groups[person.group].push(person);
            });

            // 각 조별로 차트 생성
            Object.keys(groups).sort((a, b) => {
                const numA = parseInt(a);
                const numB = parseInt(b);
                if (!isNaN(numA) && !isNaN(numB)) {
                    return numA - numB;
                }
                return a.localeCompare(b);
            }).forEach(groupNumber => {
                createChart(groups[groupNumber], groupNumber);
            });
        }

        // 전체 통계 업데이트 함수
        function updateOverallStats(data) {
            const statsContainer = document.getElementById('overallStats');
            
            if (!data || data.length === 0) {
                statsContainer.style.display = 'none';
                return;
            }

            // 통계 섹션 표시
            statsContainer.style.display = 'block';

            // 전체 인원
            const totalPeople = data.length;

            // 성별 분포
            const maleCount = data.filter(person => person.gender === '남').length;
            const femaleCount = data.filter(person => person.gender === '여').length;

            // 나이 계산
            const ages = data.map(person => calculateAge(person.birthDate)).filter(age => !isNaN(age));
            const avgAge = ages.length > 0 ? (ages.reduce((sum, age) => sum + age, 0) / ages.length) : 0;

            // 조 개수
            const groupCount = new Set(data.map(person => person.group)).size;

            // DOM 업데이트
            const statItems = statsContainer.querySelectorAll('.stat-item');
            
            // 전체 인원
            statItems[0].querySelector('.stat-number').textContent = totalPeople;
            statItems[0].querySelector('.stat-detail').textContent = `${groupCount}개 조`;

            // 남성
            statItems[1].querySelector('.stat-number').textContent = maleCount;
            statItems[1].querySelector('.stat-detail').textContent = `${((maleCount / totalPeople) * 100).toFixed(1)}%`;

            // 여성
            statItems[2].querySelector('.stat-number').textContent = femaleCount;
            statItems[2].querySelector('.stat-detail').textContent = `${((femaleCount / totalPeople) * 100).toFixed(1)}%`;

            // 평균 나이
            statItems[3].querySelector('.stat-number').textContent = avgAge.toFixed(1);
            statItems[3].querySelector('.stat-detail').textContent = '세';
        }

        // 나이 계산 함수 (한국나이)
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            // 한국나이: 현재 년도 - 태어난 년도 + 1
            return today.getFullYear() - birth.getFullYear() + 1;
        }

        // 차트 색상 팔레트
        const colorPalette = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
            '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
        ];

        // PDF 다운로드 함수
        function downloadPDF() {
            const container = document.querySelector('.container');
            const { jsPDF } = window.jspdf;
            
            // PDF 저장 버튼 임시 숨김
            const pdfBtn = document.querySelector('.pdf-btn');
            const refreshBtn = document.querySelector('.refresh-btn');
            pdfBtn.style.display = 'none';
            refreshBtn.style.display = 'none';
            
            html2canvas(container, {
                scale: 1,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.7);
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                
                let position = 0;
                
                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save('수련회_조별_나이분포.pdf');
                
                // 버튼 다시 표시
                pdfBtn.style.display = 'inline-block';
                refreshBtn.style.display = 'inline-block';
            }).catch(error => {
                console.error('PDF 생성 오류:', error);
                alert('PDF 생성 중 오류가 발생했습니다.');
                pdfBtn.style.display = 'inline-block';
                refreshBtn.style.display = 'inline-block';
            });
        }

        // 차트 생성 함수
        function createChart(groupData, groupNumber) {
            const container = document.getElementById('chartsContainer');
            
            // 차트 컨테이너 생성
            const chartItem = document.createElement('div');
            chartItem.className = 'chart-item';
            chartItem.innerHTML = `
                <div class="chart-title">${groupNumber}조 (총 ${groupData.length}명)</div>
                <canvas id="chart${groupNumber}"></canvas>
                <div class="stats" id="stats${groupNumber}"></div>
            `;
            container.appendChild(chartItem);

            // 나이 데이터 처리
            const ages = groupData.map(person => calculateAge(person.birthDate));

            // 20세부터 4살 간격 라벨 (43세까지)
            const labels = [];
            for (let i = 20; i < 44; i += 4) {
                labels.push(`${i}~${i+3}세`);
            }
            labels.push('44세 이상');

            // 연령대별 카운트
            const ageGroups = {};
            labels.forEach(label => ageGroups[label] = 0);
            ages.forEach(age => {
                if (age < 20) return;
                if (age >= 44) {
                    ageGroups['44세 이상'] += 1;
                } else {
                    const idx = Math.floor((age - 20) / 4);
                    if (idx >= 0 && idx < labels.length - 1) {
                        ageGroups[labels[idx]] += 1;
                    }
                }
            });
            const data = labels.map(label => ageGroups[label]);

            // Y축 최대값 동적 계산 (기본 4, 데이터 최대값이 5 이상이면 그에 맞춰 조정)
            const maxDataValue = Math.max(...data);
            const yAxisMax = maxDataValue >= 5 ? Math.ceil(maxDataValue / 5) * 5 : 4;

            // 차트 생성
            const ctx = document.getElementById(`chart${groupNumber}`).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '인원 수',
                        data: data,
                        backgroundColor: colorPalette[groupNumber % colorPalette.length] + '80',
                        borderColor: colorPalette[groupNumber % colorPalette.length],
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y}명`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: yAxisMax,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: '인원 수'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '연령대'
                            }
                        }
                    }
                }
            });
            
            chartInstances.push(chart);

            // 통계 정보 표시
            const avgAge = (ages.reduce((sum, age) => sum + age, 0) / ages.length).toFixed(1);
            const minAge = Math.min(...ages);
            const maxAge = Math.max(...ages);
            
            document.getElementById(`stats${groupNumber}`).innerHTML = `
                <strong>📊 통계 정보:</strong><br>
                평균 나이: ${avgAge}세 | 최연소: ${minAge}세 | 최연장: ${maxAge}세<br>
                남성: ${groupData.filter(p => p.gender === '남').length}명 | 
                여성: ${groupData.filter(p => p.gender === '여').length}명
            `;
        }

        // 샘플 데이터로 시작
        function loadSampleData() {
            // 샘플 모드 활성화 (이미 활성화되어 있지 않다면)
            if (!isSampleMode) {
                toggleSampleMode(true);
            }
            
            // 샘플 데이터 생성 (실제 데이터를 업로드하면 대체됩니다)
            const sampleData = [];
            const groups = [1, 2, 3, 4, 5];
            const birthYears = [1970, 1975, 1980, 1985, 1990, 1995, 2000, 2005];
            const genders = ['남', '여'];
            
            groups.forEach(group => {
                const groupSize = Math.floor(Math.random() * 15) + 10; // 10-24명
                for (let i = 0; i < groupSize; i++) {
                    const birthYear = birthYears[Math.floor(Math.random() * birthYears.length)];
                    const month = Math.floor(Math.random() * 12) + 1;
                    const day = Math.floor(Math.random() * 28) + 1;
                    
                    sampleData.push({
                        group: group,
                        name: `사람${group}-${i+1}`,
                        birthDate: `${birthYear}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`,
                        gender: genders[Math.floor(Math.random() * genders.length)]
                    });
                }
            });

            createChartsFromData(sampleData);
            updateLastUpdatedTime();
        }

        // 페이지 로드 시 구글 시트 데이터 가져오기
        window.addEventListener('load', function() {
            // 먼저 구글 시트에서 데이터를 가져오려고 시도
            loadGoogleSheetData();
        });
    </script>
</body>
</html>
