<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetWeEn ìˆ˜ë ¨íšŒ ì¡°ë³„ ë¶„í¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        .charts-container {
            display: grid;
            gap: 30px;
        }
        .chart-item {
            background: #fafafa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chart-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        canvas {
            max-height: 400px;
        }
        .stats {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #555;
        }
        .pdf-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px;
            transition: transform 0.2s;
        }
        .pdf-btn:hover {
            transform: translateY(-2px);
        }
        .refresh-btn {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px;
            transition: transform 0.2s;
        }
        .refresh-btn:hover {
            transform: translateY(-2px);
        }
        .loading {
            text-align: center;
            color: #667eea;
            font-size: 1.2em;
            margin: 20px 0;
        }
        .error-message {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            border-left: 4px solid #d63031;
        }
        .success-message {
            background: #e8f5e8;
            color: #00b894;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            border-left: 4px solid #00b894;
        }
        .overall-stats {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        .overall-stats h2 {
            margin: 0 0 20px 0;
            color: #333;
            text-align: center;
            font-size: 1.8em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 15px;
        }
        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        .stat-detail {
            font-size: 0.85em;
            color: #888;
        }
        .gender-chart {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }
        .gender-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #f8f9ff;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .gender-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .male-color { background: #3498db; }
        .female-color { background: #e74c3c; }
        .last-updated {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            font-size: 0.9em;
            color: #667eea;
        }
        .last-updated strong {
            color: #333;
        }
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ•ï¸ ì²­ë…„êµêµ¬ BetWeEn ìˆ˜ë ¨íšŒ ì¡°ë³„ ë¶„í¬ ğŸ‘¬</h1>
            <p>ê° ì¡°ì˜ ì—°ë ¹ëŒ€ë³„ ì¸ì› ë¶„í¬ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”</p>
        </div>
        
        <div class="controls">
            <button class="refresh-btn" onclick="loadGoogleSheetData()">
                ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
            </button>
            <button class="pdf-btn" onclick="downloadPDF()">
                ğŸ“„ PDFë¡œ ì €ì¥
            </button>
        </div>

        <div id="messageContainer"></div>
        
        <div id="overallStats" class="overall-stats" style="display: none;">
            <h2>ğŸ“Š ì „ì²´ í†µê³„</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number">0</div>
                    <div class="stat-label">ì „ì²´ ì¸ì›</div>
                    <div class="stat-detail">0ê°œ ì¡°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">0</div>
                    <div class="stat-label">ë‚¨ì„±</div>
                    <div class="stat-detail">0%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">0</div>
                    <div class="stat-label">ì—¬ì„±</div>
                    <div class="stat-detail">0%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">0</div>
                    <div class="stat-label">í‰ê·  ë‚˜ì´</div>
                    <div class="stat-detail">ì„¸</div>
                </div>
            </div>
            <div class="last-updated">
                <strong>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</strong>
            </div>
        </div>
        
        <div id="chartsContainer" class="charts-container">
            <!-- ì°¨íŠ¸ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <script>
        let chartInstances = [];
        
        // êµ¬ê¸€ ì‹œíŠ¸ CSV URL
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1gmzAJM8JgGG8fRewoPShRh4j0nWJ7LeO/export?format=csv&gid=1530529588';

        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ í•¨ìˆ˜
        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const lastUpdatedElement = document.querySelector('.last-updated');
            if (lastUpdatedElement) {
                lastUpdatedElement.innerHTML = `<strong>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</strong> ${timeString}`;
            }
        }

        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('messageContainer');
            const messageClass = type === 'error' ? 'error-message' : 
                                type === 'success' ? 'success-message' : 'loading';
            
            messageContainer.innerHTML = `<div class="${messageClass}">${message}</div>`;
            
            if (type !== 'loading') {
                setTimeout(() => {
                    messageContainer.innerHTML = '';
                }, 5000);
            }
        }

        // êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (JSONP ë°©ì‹)
        async function loadGoogleSheetData() {
            try {
                showMessage('ğŸ”„ êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...', 'loading');
                
                // ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
                const timestamp = new Date().getTime();
                const cacheBuster = `&_=${timestamp}&random=${Math.random()}`;
                const googleSheetUrlWithCacheBuster = GOOGLE_SHEET_URL + cacheBuster;
                
                // CORS í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const targetUrl = encodeURIComponent(googleSheetUrlWithCacheBuster);
                
                console.log('ìš”ì²­ URL:', proxyUrl + targetUrl);
                
                const response = await fetch(proxyUrl + targetUrl, {
                    method: 'GET',
                    cache: 'no-cache'  // ë¸Œë¼ìš°ì € ìºì‹œ ë¬´ì‹œ
                });
                
                // ì‘ë‹µ í—¤ë” ì •ë³´ ë¡œê¹…
                console.log('Response Headers:');
                for (let [key, value] of response.headers.entries()) {
                    console.log(`${key}: ${value}`);
                }
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('CSV ë°ì´í„° ê¸¸ì´:', csvText.length);
                console.log('CSV ì²« 200ì:', csvText.substring(0, 200));
                
                // CSV ë°ì´í„°ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
                if (!csvText || csvText.trim() === '') {
                    throw new Error('ë¹ˆ ë°ì´í„°ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.');
                }
                
                // ì‘ë‹µ í—¤ë”ì—ì„œ ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê°„ ì¶”ì¶œ
                const lastModified = response.headers.get('last-modified');
                const etag = response.headers.get('etag');
                const cacheControl = response.headers.get('cache-control');
                
                console.log('Last-Modified:', lastModified);
                console.log('ETag:', etag);
                console.log('Cache-Control:', cacheControl);
                
                processCSVData(csvText);
                
                // ì„±ê³µ ë©”ì‹œì§€ì— í—¤ë” ì •ë³´ í¬í•¨
                let successMessage = 'âœ… êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!';
                if (lastModified) {
                    const modifiedDate = new Date(lastModified);
                    successMessage += `<br>ğŸ“… ì‹œíŠ¸ ìˆ˜ì • ì‹œê°„: ${modifiedDate.toLocaleString('ko-KR')}`;
                }
                
                showMessage(successMessage, 'success');
                updateLastUpdatedTime();
                
            } catch (error) {
                console.error('êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
                
                // ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì‹œë„
                tryAlternativeMethod();
            }
        }

        // ëŒ€ì•ˆ ë°©ë²• ì‹œë„
        async function tryAlternativeMethod() {
            try {
                showMessage('ğŸ”„ ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...', 'loading');
                
                // ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
                const timestamp = new Date().getTime();
                const cacheBuster = `&_=${timestamp}&random=${Math.random()}`;
                const googleSheetUrlWithCacheBuster = GOOGLE_SHEET_URL + cacheBuster;
                
                // ë‹¤ë¥¸ CORS í”„ë¡ì‹œ ì‹œë„
                const corsProxy = 'https://cors-anywhere.herokuapp.com/';
                const response = await fetch(corsProxy + googleSheetUrlWithCacheBuster, {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                console.log('Alternative method - Response Headers:');
                for (let [key, value] of response.headers.entries()) {
                    console.log(`${key}: ${value}`);
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('Alternative method - CSV ë°ì´í„° ê¸¸ì´:', csvText.length);
                
                processCSVData(csvText);
                
                // ì‘ë‹µ í—¤ë”ì—ì„œ ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê°„ ì¶”ì¶œ
                const lastModified = response.headers.get('last-modified');
                let successMessage = 'âœ… êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!';
                if (lastModified) {
                    const modifiedDate = new Date(lastModified);
                    successMessage += `<br>ğŸ“… ì‹œíŠ¸ ìˆ˜ì • ì‹œê°„: ${modifiedDate.toLocaleString('ko-KR')}`;
                }
                
                showMessage(successMessage, 'success');
                updateLastUpdatedTime();
                
            } catch (error) {
                console.error('ëŒ€ì•ˆ ë°©ë²•ë„ ì‹¤íŒ¨:', error);
                showMessage('âŒ êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. CORS ì •ì±…ìœ¼ë¡œ ì¸í•œ ì œí•œì…ë‹ˆë‹¤. CSV íŒŒì¼ì„ ì§ì ‘ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.', 'error');
                
                // ìµœì¢…ì ìœ¼ë¡œ ìƒ˜í”Œ ë°ì´í„°ë¡œ ëŒ€ì²´
                setTimeout(() => {
                    showMessage('ğŸ“Š ìƒ˜í”Œ ë°ì´í„°ë¡œ ì°¨íŠ¸ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤. ì‹¤ì œ ë°ì´í„°ë¥¼ ë³´ë ¤ë©´ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'info');
                    loadSampleData();
                }, 3000);
            }
        }

        // CSV ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜
        function processCSVData(csvText) {
            try {
                const lines = csvText.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                // ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸°
                const groupIndex = headers.findIndex(h => h.includes('ì¡°') || h.includes('í¸ì„±'));
                const nameIndex = headers.findIndex(h => h.includes('ì´ë¦„'));
                const birthIndex = headers.findIndex(h => h.includes('ìƒë…„ì›”ì¼') || h.includes('ìƒì¼'));
                const genderIndex = headers.findIndex(h => h.includes('ì„±ë³„'));
                
                if (groupIndex === -1 || nameIndex === -1 || birthIndex === -1) {
                    throw new Error('í•„ìš”í•œ ì»¬ëŸ¼(ì¡°í¸ì„±, ì´ë¦„, ìƒë…„ì›”ì¼)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                // ë°ì´í„° íŒŒì‹±
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= Math.max(groupIndex, nameIndex, birthIndex, genderIndex) + 1) {
                        const groupValue = values[groupIndex];
                        const birthValue = values[birthIndex];
                        
                        // ë¹ˆ ë°ì´í„°ë‚˜ ì˜ëª»ëœ ë°ì´í„° í•„í„°ë§
                        if (groupValue && birthValue && values[nameIndex]) {
                            data.push({
                                group: parseInt(groupValue) || groupValue,
                                name: values[nameIndex],
                                birthDate: birthValue,
                                gender: genderIndex >= 0 ? values[genderIndex] : 'ë¯¸ìƒ'
                            });
                        }
                    }
                }

                createChartsFromData(data);

            } catch (error) {
                console.error('CSV ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                showMessage('âŒ ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // CSV ë¼ì¸ íŒŒì‹± (ì‰¼í‘œì™€ ë”°ì˜´í‘œ ì²˜ë¦¬)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/"/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim().replace(/"/g, ''));
            return result;
        }

        // ë°ì´í„°ë¡œë¶€í„° ì°¨íŠ¸ ìƒì„±
        function createChartsFromData(data) {
            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];
            document.getElementById('chartsContainer').innerHTML = '';

            // ì „ì²´ í†µê³„ ì—…ë°ì´íŠ¸
            updateOverallStats(data);

            // ì¡°ë³„ë¡œ ë°ì´í„° ê·¸ë£¹í™”
            const groups = {};
            data.forEach(person => {
                if (!groups[person.group]) {
                    groups[person.group] = [];
                }
                groups[person.group].push(person);
            });

            // ê° ì¡°ë³„ë¡œ ì°¨íŠ¸ ìƒì„±
            Object.keys(groups).sort((a, b) => {
                const numA = parseInt(a);
                const numB = parseInt(b);
                if (!isNaN(numA) && !isNaN(numB)) {
                    return numA - numB;
                }
                return a.localeCompare(b);
            }).forEach(groupNumber => {
                createChart(groups[groupNumber], groupNumber);
            });
        }

        // ì „ì²´ í†µê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateOverallStats(data) {
            const statsContainer = document.getElementById('overallStats');
            
            if (!data || data.length === 0) {
                statsContainer.style.display = 'none';
                return;
            }

            // í†µê³„ ì„¹ì…˜ í‘œì‹œ
            statsContainer.style.display = 'block';

            // ì „ì²´ ì¸ì›
            const totalPeople = data.length;

            // ì„±ë³„ ë¶„í¬
            const maleCount = data.filter(person => person.gender === 'ë‚¨').length;
            const femaleCount = data.filter(person => person.gender === 'ì—¬').length;

            // ë‚˜ì´ ê³„ì‚°
            const ages = data.map(person => calculateAge(person.birthDate)).filter(age => !isNaN(age));
            const avgAge = ages.length > 0 ? (ages.reduce((sum, age) => sum + age, 0) / ages.length) : 0;

            // ì¡° ê°œìˆ˜
            const groupCount = new Set(data.map(person => person.group)).size;

            // DOM ì—…ë°ì´íŠ¸
            const statItems = statsContainer.querySelectorAll('.stat-item');
            
            // ì „ì²´ ì¸ì›
            statItems[0].querySelector('.stat-number').textContent = totalPeople;
            statItems[0].querySelector('.stat-detail').textContent = `${groupCount}ê°œ ì¡°`;

            // ë‚¨ì„±
            statItems[1].querySelector('.stat-number').textContent = maleCount;
            statItems[1].querySelector('.stat-detail').textContent = `${((maleCount / totalPeople) * 100).toFixed(1)}%`;

            // ì—¬ì„±
            statItems[2].querySelector('.stat-number').textContent = femaleCount;
            statItems[2].querySelector('.stat-detail').textContent = `${((femaleCount / totalPeople) * 100).toFixed(1)}%`;

            // í‰ê·  ë‚˜ì´
            statItems[3].querySelector('.stat-number').textContent = avgAge.toFixed(1);
            statItems[3].querySelector('.stat-detail').textContent = 'ì„¸';
        }

        // ë‚˜ì´ ê³„ì‚° í•¨ìˆ˜ (í•œêµ­ë‚˜ì´)
        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            // í•œêµ­ë‚˜ì´: í˜„ì¬ ë…„ë„ - íƒœì–´ë‚œ ë…„ë„ + 1
            return today.getFullYear() - birth.getFullYear() + 1;
        }

        // ì°¨íŠ¸ ìƒ‰ìƒ íŒ”ë ˆíŠ¸
        const colorPalette = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
            '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'
        ];

        // PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadPDF() {
            const container = document.querySelector('.container');
            const { jsPDF } = window.jspdf;
            
            // PDF ì €ì¥ ë²„íŠ¼ ì„ì‹œ ìˆ¨ê¹€
            const pdfBtn = document.querySelector('.pdf-btn');
            const refreshBtn = document.querySelector('.refresh-btn');
            pdfBtn.style.display = 'none';
            refreshBtn.style.display = 'none';
            
            html2canvas(container, {
                scale: 1,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.7);
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                
                let position = 0;
                
                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save('ìˆ˜ë ¨íšŒ_ì¡°ë³„_ë‚˜ì´ë¶„í¬.pdf');
                
                // ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
                pdfBtn.style.display = 'inline-block';
                refreshBtn.style.display = 'inline-block';
            }).catch(error => {
                console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
                alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                pdfBtn.style.display = 'inline-block';
                refreshBtn.style.display = 'inline-block';
            });
        }

        // ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜
        function createChart(groupData, groupNumber) {
            const container = document.getElementById('chartsContainer');
            
            // ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ìƒì„±
            const chartItem = document.createElement('div');
            chartItem.className = 'chart-item';
            chartItem.innerHTML = `
                <div class="chart-title">${groupNumber}ì¡° (ì´ ${groupData.length}ëª…)</div>
                <canvas id="chart${groupNumber}"></canvas>
                <div class="stats" id="stats${groupNumber}"></div>
            `;
            container.appendChild(chartItem);

            // ë‚˜ì´ ë°ì´í„° ì²˜ë¦¬
            const ages = groupData.map(person => calculateAge(person.birthDate));

            // 20ì„¸ë¶€í„° 4ì‚´ ê°„ê²© ë¼ë²¨ (43ì„¸ê¹Œì§€)
            const labels = [];
            for (let i = 20; i < 44; i += 4) {
                labels.push(`${i}~${i+3}ì„¸`);
            }
            labels.push('44ì„¸ ì´ìƒ');

            // ì—°ë ¹ëŒ€ë³„ ì¹´ìš´íŠ¸
            const ageGroups = {};
            labels.forEach(label => ageGroups[label] = 0);
            ages.forEach(age => {
                if (age < 20) return;
                if (age >= 44) {
                    ageGroups['44ì„¸ ì´ìƒ'] += 1;
                } else {
                    const idx = Math.floor((age - 20) / 4);
                    if (idx >= 0 && idx < labels.length - 1) {
                        ageGroups[labels[idx]] += 1;
                    }
                }
            });
            const data = labels.map(label => ageGroups[label]);

            // Yì¶• ìµœëŒ€ê°’ ë™ì  ê³„ì‚° (ê¸°ë³¸ 4, ë°ì´í„° ìµœëŒ€ê°’ì´ 5 ì´ìƒì´ë©´ ê·¸ì— ë§ì¶° ì¡°ì •)
            const maxDataValue = Math.max(...data);
            const yAxisMax = maxDataValue >= 5 ? Math.ceil(maxDataValue / 5) * 5 : 4;

            // ì°¨íŠ¸ ìƒì„±
            const ctx = document.getElementById(`chart${groupNumber}`).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì¸ì› ìˆ˜',
                        data: data,
                        backgroundColor: colorPalette[groupNumber % colorPalette.length] + '80',
                        borderColor: colorPalette[groupNumber % colorPalette.length],
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y}ëª…`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: yAxisMax,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'ì¸ì› ìˆ˜'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ì—°ë ¹ëŒ€'
                            }
                        }
                    }
                }
            });
            
            chartInstances.push(chart);

            // í†µê³„ ì •ë³´ í‘œì‹œ
            const avgAge = (ages.reduce((sum, age) => sum + age, 0) / ages.length).toFixed(1);
            const minAge = Math.min(...ages);
            const maxAge = Math.max(...ages);
            
            document.getElementById(`stats${groupNumber}`).innerHTML = `
                <strong>ğŸ“Š í†µê³„ ì •ë³´:</strong><br>
                í‰ê·  ë‚˜ì´: ${avgAge}ì„¸ | ìµœì—°ì†Œ: ${minAge}ì„¸ | ìµœì—°ì¥: ${maxAge}ì„¸<br>
                ë‚¨ì„±: ${groupData.filter(p => p.gender === 'ë‚¨').length}ëª… | 
                ì—¬ì„±: ${groupData.filter(p => p.gender === 'ì—¬').length}ëª…
            `;
        }

        // ìƒ˜í”Œ ë°ì´í„°ë¡œ ì‹œì‘
        function loadSampleData() {
            // ìƒ˜í”Œ ë°ì´í„° ìƒì„± (ì‹¤ì œ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ëŒ€ì²´ë©ë‹ˆë‹¤)
            const sampleData = [];
            const groups = [1, 2, 3, 4, 5];
            const birthYears = [1970, 1975, 1980, 1985, 1990, 1995, 2000, 2005];
            const genders = ['ë‚¨', 'ì—¬'];
            
            groups.forEach(group => {
                const groupSize = Math.floor(Math.random() * 15) + 10; // 10-24ëª…
                for (let i = 0; i < groupSize; i++) {
                    const birthYear = birthYears[Math.floor(Math.random() * birthYears.length)];
                    const month = Math.floor(Math.random() * 12) + 1;
                    const day = Math.floor(Math.random() * 28) + 1;
                    
                    sampleData.push({
                        group: group,
                        name: `ì‚¬ëŒ${group}-${i+1}`,
                        birthDate: `${birthYear}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`,
                        gender: genders[Math.floor(Math.random() * genders.length)]
                    });
                }
            });

            createChartsFromData(sampleData);
            updateLastUpdatedTime();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        window.addEventListener('load', function() {
            // ë¨¼ì € êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë ¤ê³  ì‹œë„
            loadGoogleSheetData();
        });
    </script>
</body>
</html>
